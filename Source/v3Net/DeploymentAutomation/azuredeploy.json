{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "comments": "This template is having the Meetuply Bot code and necessary resources provisioned accordingly", 
        "author": "Pranav S. Krishnamurthy"
    },
    "parameters": {
        "botAppID": {
            "type": "string",
            "metadata": {
                "description": "This is the Azure Application ID"
            }
        },
        "botApplicationPassword": {
            "type": "string", 
            "metadata": {
                "description": "This is the Azure Application Password"
            }
        },
        "botDisplayName":{
            "type": "string", 
            "metadata": {
                "description": "This is the name of the bot that would show when the bot gives a reply"
            },
            "defaultValue": "Meetuply"
        },
        "botDescription":{
            "type": "string",
            "metadata": {
                "description": "Give a description of what the bot does"
            }
        }, 
        "iconUrl": {
            "type": "string", 
            "metadata": {
                "description": "This is the link to the icon for the bot and it must resolve to a PNG file"
            }, 
            "defaultValue": "https://raw.githubusercontent.com/coderkrishna/TeamsMeetuplyBot/master/Source/v3Net/MeetupBot/manifest/color.png"
        },
        "key": {
            "type": "string", 
            "metadata": {
                "description": "This is a randomly generated string from the PowerShell console"
            }
        },
        "repoUrl" :{
            "type": "string", 
            "metadata": {
                "description": "This is the source code repository on GitHub"
            }
        },
        "branch": {
            "type":"string", 
            "metadata": {
                "description": "If there are some custom code changes that were made to the Meetuply source code on a separate branch, include the branch name here"
            },
            "defaultValue": "master"
        }, 
        "feedbackEmail": {
            "type":"string", 
            "metadata": {
                "description": "The contact email address to give feedback"
            }
        }, 
        "logicAppFrequency": {
            "type":"string", 
            "metadata": {
                "description": "The frequency by which the bot will automatically pair up members of a team"
            }
        },
        "logicAppInterval": {
            "type":"int", 
            "metadata": {
                "description": "At which interval should the pair ups happen (i.e. 1 Week = Weekly, etc..)"
            }
        }, 
        "logicAppHour": {
            "type":"int", 
            "metadata": {
                "description": "The hour at which the automatic pair ups can happen"
            }
        }, 
        "logicAppMins": {
            "type": "int", 
            "metadata": {
                "description": "The exact minute for which the automatic pair ups can happen"
            }
        },
        "logicAppDOW": {
            "type":"string", 
            "metadata": {
                "description": "The day of the week when the automatic pair ups will take place"
            }
        }, 
        "logicAppTimeZone": {
            "type":"string", 
            "metadata": {
                "description": "The time zone in which the pair ups will happen"
            }
        }
    },
    "variables": {
        "botName": "[concat('meetup-', uniqueString(resourceGroup().id))]",
        "CosmosDbName":"[concat('meetuplydb-', uniqueString(resourceGroup().id))]",
        "defaultExperience":"Core (SQL)",
        "logicAppName":"meetuplyALA",
        "meetuplyAppInsightsName": "appInsightsMeetuply"
    },
    "resources": [
        {
            "name":"[variables('botName')]",
            "type": "Microsoft.BotService/botServices",
            "location": "global",
            "apiVersion": "2018-07-12",
            "tags": {},
            "sku": {
                "name": "F0"
            }, 
            "kind": "sdk", 
            "properties": {
                "displayName":"[parameters('botDisplayName')]",
                "description":"[parameters('botDescription')]",
                "endpoint": "[concat('https://', variables('botName'), '-svc.azurewebsites.net/api/messages')]",
                "iconUrl": "[parameters('iconUrl')]",
                "msaAppId":"[parameters('botAppID')]",
                "developerAppInsightKey": "[reference(resourceId('Microsoft.Insights/components', variables('meetuplyAppInsightsName')), '2015-05-01').InstrumentationKey]"
            },
            "resources": [
                {
                    "name": "[concat(variables('botName'), '/MsTeamsChannel')]", 
                    "type": "Microsoft.BotService/botServices/channels", 
                    "apiVersion": "2018-07-12",
                    "location": "global",
                    "tags": {}, 
                    "sku": {
                        "name":"F0"
                    }, 
                    "properties": {
                        "channelName":"MsTeamsChannel",
                        "location":"global", 
                        "properties": {
                            "isEnabled":true
                        }
                    }, 
                    "dependsOn": [
                        "[concat('Microsoft.BotService/botServices/', variables('botName'))]"
                    ]
                }
            ]
        },
        {
           "type":"Microsoft.Web/serverfarms",
           "apiVersion": "2018-02-01", 
           "location": "[resourceGroup().location]", 
           "name": "meetuplyHostingPlan", 
           "sku": {
               "name": "S1", 
               "capacity": "0"
           }, 
           "properties": {
               "name": "meetuplyHostingPlan"
           }
        },
        {
            "type": "Microsoft.Web/sites", 
            "kind":"app", 
            "name": "[concat(variables('botName'), '-svc')]", 
            "apiVersion": "2016-08-01",
            "location": "[resourceGroup().location]",
            "scale": null,
            "properties":{
                "enabled":true, 
                "hostNameSslStates": [
                    {
                        "name": "[concat(variables('botName'),'-svc.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Standard"
                    },
                    {
                        "name": "[concat(variables('botName'),'-svc.scm.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Repository"
                    }
                ],
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', 'meetuplyHostingPlan')]",
                "reserved": false,
                "siteConfig": {
                   "appSettings": [
                        {
                            "name": "microsoftAppID",
                            "value": "[parameters('botAppID')]"
                        },
                        {
                            "name": "microsoftAppPassword",
                            "value": "[parameters('botApplicationPassword')]"
                        },
                        {
                            "name": "CosmosDBKey", 
                            "value": "[listKeys(concat('Microsoft.DocumentDB/databaseAccounts/', variables('CosmosDbName')), '2015-04-08').primaryMasterKey]"
                        },
                        {
                            "name": "CosmosDBEndpointUrl", 
                            "value": "[reference(concat('Microsoft.DocumentDb/databaseAccounts/', variables('CosmosDbName'))).documentEndpoint]"
                        },
                        {
                            "name": "CosmosDBDatabaseName", 
                            "value": "MeetupBotConfig"
                        },
                        {
                            "name": "CosmosCollectionTeams", 
                            "value": "TeamsInstalled"
                        },
                        {
                            "name": "CosmosCollectionUsers", 
                            "value": "UsersOptInStatus"
                        },
                        {
                            "name": "MaxPairHistory", 
                            "value": "5"
                        },
                        {
                            "name": "MaxPairUpsPerTeam",
                            "value": "5000"
                        },
                        {
                            "name": "Key",
                            "value": "[parameters('key')]"
                        },
                        {
                            "name": "BotDisplayName", 
                            "value": "[parameters('botDisplayName')]"
                        },
                        {
                            "name": "WEBSITE_NODE_DEFAULT_VERSION",
                            "value": "8.9.4"
                        }, 
                        {
                            "name": "ContactEmail", 
                            "value": "[parameters('feedbackEmail')]"
                        },
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                            "value": "[reference(resourceId('Microsoft.Insights/components', variables('meetuplyAppInsightsName')), '2015-05-01').InstrumentationKey]"
                        }
                    ]
                },
                "scmSiteAlsoStopped": "false", 
                "scmType": "ExternalGit",
                "hostingEnvironmentProfile": null,
                "clientAffinityEnabled": true,
                "clientCertEnabled": false,
                "hostNamesDisabled": false,
                "containerSize": 0,
                "dailyMemoryTimeQuota": 0,
                "cloningInfo": null,
                "httpsOnly": false
            },
            "dependsOn": [
                "[concat('Microsoft.Web/serverfarms/', 'meetuplyHostingPlan')]"
            ],
            "resources":[
                {
                    "apiVersion": "2015-08-01", 
                    "name":"web", 
                    "type": "sourcecontrols", 
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', variables('botName'), '-svc')]"
                    ],
                    "properties":{
                        "RepoUrl": "[parameters('repoUrl')]", 
                        "branch": "[parameters('branch')]", 
                        "IsManualIntegration": true
                    }
                }
            ]
        },
        {
            "name": "[variables('CosmosDbName')]", 
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2015-04-08",
            "location": "[resourceGroup().location]",
            "kind":"GlobalDocumentDB",
            "scale": null,
            "properties": {
                "ipRangeFilter": "",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": true,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Session",
                    "maxIntervalInSeconds": 5,
                    "maxStalenessPrefix": 100
                },
                "locations": [
                    {
                        "locationName": "[resourceGroup().location]",
                        "provisioningState": "Succeeded",
                        "failoverPriority": 0
                    }
                ],
                "capabilities": []
            },
            "tags": {
                "defaultExperience":"[variables('defaultExperience')]"
            }
        }, 
        {
            "comments": "This is the Azure Logic App that replaces the scheduled job", 
            "name": "[variables('logicAppName')]", 
            "type": "Microsoft.Logic/workflows", 
            "apiVersion": "2016-06-01", 
            "location": "[resourceGroup().location]",
            "tags": {},
            "scale": null,
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "triggers": {
                        "Recurrence": {
                            "recurrence": {
                                "frequency": "[parameters('logicAppFrequency')]",
                                "interval": "[parameters('logicAppInterval')]",
                                "schedule": {
                                    "hours": [
                                        "[parameters('logicAppHour')]"
                                    ],
                                    "minutes": [
                                        "[parameters('logicAppMins')]"
                                    ],
                                    "weekDays": [
                                        "[parameters('logicAppDOW')]"
                                    ]
                                },
                                "timeZone": "[parameters('logicAppTimeZone')]"
                            },
                            "type": "Recurrence"
                        }
                    },
                    "actions": {
                        "HTTP": {
                            "runAfter": {},
                            "type": "Http",
                            "inputs": {
                                "method": "GET",
                                "uri": "[concat('https://', variables('botName'), '-svc.azurewebsites.net/api/processnow/', parameters('key'))]"
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {}
            },
            "dependsOn": []
        },
        {
            "name": "[variables('meetuplyAppInsightsName')]",
            "type": "Microsoft.Insights/components",
            "kind": "other",
            "apiVersion": "2015-05-01",
            "location": "[resourceGroup().location]",
            "tags": {},
            "scale": null,
            "properties": {
                "Application_Type": "other"
            },
            "dependsOn": []
        }
    ],
    "outputs": {
        "outputBotName": {
            "type": "string",
            "value": "[variables('botName')]"
        }, 
        "outputBotDisplayName": {
            "type": "string", 
            "value": "[parameters('botDisplayName')]"
        },
        "outputBotAppId": {
            "type": "string", 
            "value":"[parameters('botAppID')]"
        }
    }
}