{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "botAppID": {
            "type": "string",
            "metadata": {
                "description": "This is the Azure Application ID"
            }
        },
        "botApplicationPassword": {
            "type": "securestring",
            "metadata": {
                "description": "This is the Azure Application Password"
            }
        },
        "botDisplayName": {
            "type": "string",
            "metadata": {
                "description": "This is the name of the bot that would show when the bot gives a reply"
            },
            "defaultValue": "Icebreaker"
        },
        "botDescription": {
            "type": "string",
            "metadata": {
                "description": "Give a description of what the bot does"
            }
        },
        "iconUrl": {
            "type": "string",
            "metadata": {
                "description": "This is the link to the icon for the bot and it must resolve to a PNG file"
            }, 
            "defaultValue": "https://raw.githubusercontent.com/OfficeDev/microsoft-teams-icebreaker-app/master/Source/v3Net/Icebreaker/Manifest/color.png"
        },
        "key": {
            "type": "string",
            "metadata": {
                "description": "This is a randomly generated string from the PowerShell console"
            }
        },
        "repoUrl": {
            "type": "string",
            "metadata": {
                "description": "This is the source code repository on GitHub"
            }
        },
        "branch": {
            "type": "string",
            "metadata": {
                "description": "If there are some custom code changes that were made to the Icebreaker source code on a separate branch, include the branch name here"
            },
            "defaultValue": "master"
        },
        "feedbackEmail": {
            "type": "string",
            "metadata": {
                "description": "The contact email address to give feedback"
            }
        },
        "logicAppFrequency": {
            "type": "string",
            "allowedValues": [
                "Week",
                "Month"
            ],
            "metadata": {
                "description": "The frequency by which the bot will automatically pair up members of a team"
            },
            "defaultValue": "Week"
        },
        "logicAppInterval": {
            "type": "int",
            "metadata": {
                "description": "How many times per the frequency the bot will randomly pair up members of a team (i.e. 1 Month, or 1 Week)"
            }, 
            "defaultValue": "1"
        },
        "logicAppHour": {
            "type": "int",
            "allowedValues": [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23
            ],
            "metadata": {
                "description": "Select the hour at which the bot will automatically pair members of a team"
            },
            "defaultValue": "10"
        },
        "logicAppMins": {
            "type": "int",
            "allowedValues": [
                0,
                1,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
                27,
                28,
                29,
                30,
                31,
                32,
                33,
                34,
                35,
                36,
                37,
                38,
                39,
                40,
                41,
                42,
                43,
                44,
                45,
                46,
                47,
                48,
                49,
                50,
                51,
                52,
                53,
                54,
                55,
                56,
                57,
                58,
                59
            ],
            "metadata": {
                "description": "Select the minute at which the bot will automatically pair members of a team"
            },
            "defaultValue": "0"
        },
        "logicAppDOW": {
            "type":"string", 
            "allowedValues": [
                "Sunday", 
                "Monday", 
                "Tuesday", 
                "Wednesday", 
                "Thursday", 
                "Friday", 
                "Saturday"
            ], 
            "metadata":{
                "description": "The day of the week that your bot can automatically pair up team members"
            },
            "defaultValue": "Monday"
        }, 
        "logicAppTimeZone": {
            "type":"string", 
            "metadata": {
                "description": "If there are some custom code changes that were made to the Icebreaker source code on a separate branch, include the branch name here"
            },
            "defaultValue": "Pacific Standard Time"
        },
        "manifestAppId": {
            "type":"string", 
            "metadata": {
                "description": "The external ID of the application manifest"
            }
        }
    },
    "variables": {
        "botName": "[concat('icebreaker-', uniqueString(resourceGroup().id))]",
        "CosmosDbName":"[concat('icebreaker-', uniqueString(resourceGroup().id))]",
        "defaultExperience":"Core (SQL)",
        "logicAppName":"icebreakerALA",
        "appInsightsName": "icebreakerAppInsights"
    },
    "resources": [
        {
            "name": "[variables('botName')]",
            "type": "Microsoft.BotService/botServices",
            "location": "global",
            "apiVersion": "2018-07-12",
            "tags": {},
            "sku": {
                "name": "F0"
            },
            "kind": "sdk",
            "properties": {
                "displayName": "[parameters('botDisplayName')]",
                "description": "[parameters('botDescription')]",
                "endpoint": "[concat('https://', variables('botName'), '-svc.azurewebsites.net/api/messages')]",
                "iconUrl": "[parameters('iconUrl')]",
                "msaAppId":"[parameters('botAppID')]",
                "developerAppInsightKey": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2015-05-01').InstrumentationKey]"
            },
            "resources": [
                {
                    "name": "[concat(variables('botName'), '/MsTeamsChannel')]",
                    "type": "Microsoft.BotService/botServices/channels",
                    "apiVersion": "2018-07-12",
                    "location": "global",
                    "tags": {},
                    "sku": {
                        "name": "F0"
                    },
                    "properties": {
                        "channelName": "MsTeamsChannel",
                        "location": "global",
                        "properties": {
                            "isEnabled": true
                        }
                    },
                    "dependsOn": [
                        "[concat('Microsoft.BotService/botServices/', variables('botName'))]"
                    ]
                }
            ]
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2018-02-01",
            "location": "[resourceGroup().location]",
            "name": "icebreakerHostingPlan",
            "sku": {
                "name": "S1",
                "capacity": "0"
            },
            "properties": {
                "name": "icebreakerHostingPlan"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "kind": "app",
            "name": "[concat(variables('botName'), '-svc')]",
            "apiVersion": "2016-08-01",
            "location": "[resourceGroup().location]",
            "scale": null,
            "properties": {
                "enabled": true,
                "hostNameSslStates": [
                    {
                        "name": "[concat(variables('botName'),'-svc.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Standard"
                    },
                    {
                        "name": "[concat(variables('botName'),'-svc.scm.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Repository"
                    }
                ],
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', 'icebreakerHostingPlan')]",
                "reserved": false,
                "siteConfig": {
                    "appSettings": [
                        {
                            "name": "microsoftAppID",
                            "value": "[parameters('botAppID')]"
                        },
                        {
                            "name": "microsoftAppPassword",
                            "value": "[parameters('botApplicationPassword')]"
                        },
                        {
                            "name": "ManifestAppId", 
                            "value": "[parameters('manifestAppId')]"
                        },
                        {
                            "name": "CosmosDBKey",
                            "value": "[listKeys(concat('Microsoft.DocumentDB/databaseAccounts/', variables('CosmosDbName')), '2015-04-08').primaryMasterKey]"
                        },
                        {
                            "name": "CosmosDBEndpointUrl",
                            "value": "[reference(concat('Microsoft.DocumentDb/databaseAccounts/', variables('CosmosDbName'))).documentEndpoint]"
                        },
                        {
                            "name": "CosmosDBDatabaseName",
                            "value": "MeetupBotConfig"
                        },
                        {
                            "name": "CosmosCollectionTeams",
                            "value": "TeamsInstalled"
                        },
                        {
                            "name": "CosmosCollectionUsers",
                            "value": "UsersOptInStatus"
                        },
                        {
                            "name": "MaxPairHistory",
                            "value": "5"
                        },
                        {
                            "name": "MaxPairUpsPerTeam",
                            "value": "5000"
                        },
                        {
                            "name": "Key",
                            "value": "[parameters('key')]"
                        },
                        {
                            "name": "BotDisplayName",
                            "value": "[parameters('botDisplayName')]"
                        },
                        {
                            "name": "WEBSITE_NODE_DEFAULT_VERSION",
                            "value": "8.9.4"
                        }, 
                        {
                            "name": "ContactEmail", 
                            "value": "[parameters('feedbackEmail')]"
                        },
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY", 
                            "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2015-05-01').InstrumentationKey]"
                        }
                    ]
                },
                "scmSiteAlsoStopped": "false",
                "scmType": "ExternalGit",
                "hostingEnvironmentProfile": null,
                "clientAffinityEnabled": true,
                "clientCertEnabled": false,
                "hostNamesDisabled": false,
                "containerSize": 0,
                "dailyMemoryTimeQuota": 0,
                "cloningInfo": null,
                "httpsOnly": false
            },
            "dependsOn": [
                "[concat('Microsoft.Web/serverfarms/', 'icebreakerHostingPlan')]"
            ],
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "sourcecontrols",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', variables('botName'), '-svc')]"
                    ],
                    "properties": {
                        "RepoUrl": "[parameters('repoUrl')]",
                        "branch": "[parameters('branch')]",
                        "IsManualIntegration": true
                    }
                }
            ]
        },
        {
            "name": "[variables('CosmosDbName')]",
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2015-04-08",
            "location": "[resourceGroup().location]",
            "kind": "GlobalDocumentDB",
            "scale": null,
            "properties": {
                "ipRangeFilter": "",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": true,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Session",
                    "maxIntervalInSeconds": 5,
                    "maxStalenessPrefix": 100
                },
                "locations": [
                    {
                        "locationName": "[resourceGroup().location]",
                        "provisioningState": "Succeeded",
                        "failoverPriority": 0
                    }
                ],
                "capabilities": []
            },
            "tags": {
                "defaultExperience": "[variables('defaultExperience')]"
            }
        }, 
        {
            "name": "[variables('logicAppName')]", 
            "type": "Microsoft.Logic/workflows", 
            "apiVersion": "2016-06-01", 
            "location": "[resourceGroup().location]",
            "tags": {},
            "scale": null,
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "triggers": {
                        "Recurrence": {
                            "recurrence": {
                                "frequency": "[parameters('logicAppFrequency')]",
                                "interval": "[parameters('logicAppInterval')]",
                                "schedule": {
                                    "hours": [
                                        "[parameters('logicAppHour')]"
                                    ],
                                    "minutes": [
                                        "[parameters('logicAppMins')]"
                                    ],
                                    "weekDays": [
                                        "[parameters('logicAppDOW')]"
                                    ]
                                },
                                "timeZone": "[parameters('logicAppTimeZone')]"
                            },
                            "type": "Recurrence"
                        }
                    },
                    "actions": {
                        "HTTP": {
                            "runAfter": {},
                            "type": "Http",
                            "inputs": {
                                "method": "GET",
                                "uri": "[concat('https://', variables('botName'), '-svc.azurewebsites.net/api/processnow/', parameters('key'))]"
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {}
            },
            "dependsOn": []
        },
        {
            "name": "[variables('appInsightsName')]",
            "type": "Microsoft.Insights/components",
            "kind": "other",
            "apiVersion": "2015-05-01",
            "location": "[resourceGroup().location]",
            "tags": {},
            "scale": null,
            "properties": {
                "Application_Type": "other"
            },
            "dependsOn": []
        }
    ],
    "outputs": {
        "outputBotName": {
            "type": "string",
            "value": "[variables('botName')]"
        },
        "outputBotDisplayName": {
            "type": "string",
            "value": "[parameters('botDisplayName')]"
        },
        "outputBotAppId": {
            "type": "string",
            "value": "[parameters('botAppID')]"
        }
    }
}